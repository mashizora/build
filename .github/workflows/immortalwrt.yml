name: immortalwrt
on: workflow_dispatch

env:
  IMAGEBUILDER: https://downloads.immortalwrt.org/releases/23.05.0/targets/x86/64/immortalwrt-imagebuilder-23.05.0-x86-64.Linux-x86_64.tar.xz

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: immortalwrt
    steps:
      - uses: actions/checkout@v4
      - name: Setup build environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install libncurses5-dev libncursesw5-dev gettext xsltproc
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean

      - name: Download imagebuilder
        run: |
          curl -s -L $IMAGEBUILDER -o builder.tar.xz
          tar -Jxf builder.tar.xz --strip-components=1

      - name: Patch build config
        run: |
          sed -i '/CONFIG_ISO_IMAGES/d' .config
          sed -i '/CONFIG_VDI_IMAGES/d' .config
          sed -i '/CONFIG_GRUB_IMAGES/d' .config
          sed -i '/CONFIG_VHDX_IMAGES/d' .config
          sed -i '/CONFIG_VMDK_IMAGES/d' .config
          sed -i '/CONFIG_QCOW2_IMAGES/d' .config
          sed -i '/CONFIG_TARGET_ROOTFS_EXT4FS/d' .config

      - name: Build images
        run: |
          make image FILES="files" PACKAGES="luci-app-homeproxy"

      - name: Upload images
        uses: actions/upload-artifact@v3
        with:
          name: immortalwrt
          path: immortalwrt/bin/targets/x86/64/
